version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - |
              echo "Checking for changes in service project..."

              # Try to get changed files
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --pretty="" HEAD 2>/dev/null || echo "")

              # If we can't detect changes (new branch, first commit, etc.), always build
              if [ -z "$CHANGED_FILES" ]; then
                echo "Cannot detect changes (possibly new branch or first commit), proceeding with build for safety"
              else
                echo "Changed files: $CHANGED_FILES"
                
                # Check if service or backend files changed
                if echo "$CHANGED_FILES" | grep -E "^(apps/service|packages/amplify-backend)" > /dev/null; then
                  echo "Service changes detected, proceeding with build"
                else
                  echo "No service changes, skipping build"
                  exit 0
                fi
              fi

              echo "Building service..."
            - npm install
            - npx ampx generate outputs --branch $AWS_BRANCH --app-id d31tu5e07ftf7t --out-dir packages/amplify-backend
            - echo "COGNITO_USER_POOL_CLIENT_ID=$COGNITO_USER_POOL_CLIENT_ID" >> apps/service/.env
            - echo "GOOGLE_CLIENT_EMAIL=$GOOGLE_CLIENT_EMAIL" >> apps/service/.env
            - echo "GOOGLE_PRIVATE_KEY=$GOOGLE_PRIVATE_KEY" >> apps/service/.env
            - echo "GOOGLE_SPREADSHEET_ID=$GOOGLE_SPREADSHEET_ID" >> apps/service/.env
            - echo "MISOCA_SECRET=$MISOCA_SECRET" >> apps/service/.env
            - echo "STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY" >> apps/service/.env
            - echo "RECAPTCHA_SECRET_KEY=$RECAPTCHA_SECRET_KEY" >> apps/service/.env
            - echo "AMAZON_SES_EMAIL=$AMAZON_SES_EMAIL" >> apps/service/.env
        build:
          commands:
            - npx turbo run build --filter=service
      artifacts:
        baseDirectory: apps/service/.next
        files:
          - "**/*"
      cache:
        paths:
          - .next/cache/**/*
          - node_modules/**/*
      buildPath: /
    appRoot: apps/service
